/*
 * Released under BSD License
 * Copyright (c) 2014-2015 hizzgdev@163.com
 *
 * Project Home:
 *   https://github.com/hizzgdev/jsmind/
 */
 
!function(t){"use strict";let e=t.jsMind;if(e&&void 0===e.screenshot){let i=t.document,n=function(t){return i.createElement(t)},a=function(t,e){return t.getPropertyValue(e)},o=function(t){let e=a(t,"visibility"),i=a(t,"display");return"hidden"!==e&&"none"!==i},s=e.util.canvas;s.rect=function(t,e,i,n,a,o){n<2*o&&(o=n/2),a<2*o&&(o=a/2),t.moveTo(e+o,i),t.arcTo(e+n,i,e+n,i+a,o),t.arcTo(e+n,i+a,e,i+a,o),t.arcTo(e,i+a,e,i,o),t.arcTo(e,i,e+n,i,o)},s.text_multiline=function(t,e,i,n,a,o,s){let r="",l=e.length,c=e.split(""),h=null;t.textAlign="left",t.textBaseline="top";for(let d=0;d<l;d++)h=r+c[d],t.measureText(h).width>a&&d>0?(t.fillText(r,i,n),r=c[d],n+=s):r=h;t.fillText(r,i,n)},s.text_ellipsis=function(t,e,i,n,a,o){let r=n+o/2;e=s.fittingString(t,e,a);t.textAlign="left",t.textBaseline="middle",t.fillText(e,i,r,a)},s.fittingString=function(t,e,i){let n=t.measureText(e).width,a=t.measureText("…").width;if(n<=i||n<=a)return e;for(let o=e.length;n>=i-a&&o-- >0;)e=e.substring(0,o),n=t.measureText(e).width;return e+"…"},s.image=function(t,e,i,n,a,o,r,l,c){let h=new Image;h.onload=function(){t.save(),t.translate(i,n),t.save(),t.beginPath(),s.rect(t,0,0,a,o,r),t.closePath(),t.clip(),t.translate(a/2,o/2),t.rotate(l*Math.PI/180),t.drawImage(h,-a/2,-o/2),t.restore(),t.restore(),c()},h.src=e},e.screenshot=function(t){this.jm=t,this.canvas_elem=null,this.canvas_ctx=null,this._inited=!1},e.screenshot.prototype={init:function(){if(!this._inited){console.log("init");let t=n("canvas"),e=t.getContext("2d");this.canvas_elem=t,this.canvas_ctx=e,this.jm.view.e_panel.appendChild(t),this._inited=!0,this.resize()}},shoot:function(t){this.init();let e=this;this._draw(function(){t&&t(e),e.clean()}),this._watermark()},shootDownload:function(){this.shoot(function(t){t._download()})},shootAsDataURL:function(t){this.shoot(function(e){t(e.canvas_elem.toDataURL())})},resize:function(){this._inited&&(this.canvas_elem.width=this.jm.view.size.w,this.canvas_elem.height=this.jm.view.size.h)},clean:function(){let t=this.canvas_elem;this.canvas_ctx.clearRect(0,0,t.width,t.height)},_draw:function(t){let e=this.canvas_ctx;e.textAlign="left",e.textBaseline="top",this._draw_lines(),this._draw_nodes(t)},_watermark:function(){let e=this.canvas_elem,i=this.canvas_ctx;i.textAlign="right",i.textBaseline="bottom",i.fillStyle="#000",i.font="11px Verdana,Arial,Helvetica,sans-serif",i.fillText("hizzgdev.github.io/jsmind",e.width-5.5,e.height-2.5),i.textAlign="left",i.fillText(t.location,5.5,e.height-2.5)},_draw_lines:function(){this.jm.view.show_lines(this.canvas_ctx)},_draw_nodes:function(e){let i,n=this.jm.mind.nodes;for(let a in n)i=n[a],this._draw_node(i);!function a(){console.log("check_node_ready"+new Date);let o=!0;for(let s in n)o&=(i=n[s]).ready;o?t.setTimeout(e,200):t.setTimeout(a,200)}()},_draw_node:function(t){let e=this.canvas_ctx,i=t._data.view,n=i.element,r=getComputedStyle(n);if(o(r)){let l=a(r,"background-color"),c=parseInt(a(r,"border-top-left-radius")),h=a(r,"color"),d=parseInt(a(r,"padding-left")),v=parseInt(a(r,"padding-right")),f=parseInt(a(r,"padding-top")),u=parseInt(a(r,"padding-bottom")),_=a(r,"text-overflow"),g=a(r,"font-style")+" "+a(r,"font-variant")+" "+a(r,"font-weight")+" "+a(r,"font-size")+"/"+a(r,"line-height")+" "+a(r,"font-family"),m={x:i.abs_x,y:i.abs_y,w:i.width+1,h:i.height+1},w={x:m.x+d,y:m.y+f,w:m.w-d-v,h:m.h-f-u};if(e.font=g,e.fillStyle=l,e.beginPath(),s.rect(e,m.x,m.y,m.w,m.h,c),e.closePath(),e.fill(),e.fillStyle=h,"background-image"in t.data){let x=a(r,"background-image").slice(5,-2);t.ready=!1;let p=0;"background-rotation"in t.data&&(p=t.data["background-rotation"]),s.image(e,x,m.x,m.y,m.w,m.h,c,p,function(){t.ready=!0})}if(t.topic)if("ellipsis"===_)s.text_ellipsis(e,t.topic.innerText,w.x,w.y,w.w,w.h);else{let y=parseInt(a(r,"line-height"));s.text_multiline(e,t.topic.innerText,w.x,w.y,w.w,w.h,y)}i.expander&&this._draw_expander(i.expander),"background-image"in t.data||(t.ready=!0)}else t.ready=!0},_draw_expander:function(t){let e=this.canvas_ctx,i=getComputedStyle(t);if(o(i)){let n=a(i,"left"),s=a(i,"top"),r=(a(i,"font"),parseInt(n)),l=parseInt(s),c="+"===t.innerHTML;e.lineWidth=1,e.beginPath(),e.arc(r+7,l+7,5,0,2*Math.PI,!0),e.moveTo(r+10,l+7),e.lineTo(r+4,l+7),c&&(e.moveTo(r+7,l+4),e.lineTo(r+7,l+10)),e.closePath(),e.stroke()}},_download:function(){let t=this.canvas_elem,e=this.jm.mind.name+".png";if(navigator.msSaveBlob&&t.msToBlob){let a=t.msToBlob();navigator.msSaveBlob(a,e)}else{let o=this.canvas_elem.toDataURL(),s=n("a");if("download"in s){s.style.visibility="hidden",s.href=o,s.download=e,i.body.appendChild(s);let r=i.createEvent("MouseEvents");r.initEvent("click",!0,!0),s.dispatchEvent(r),i.body.removeChild(s)}else location.href=o}},jm_event_handle:function(t,i){t===e.event_type.resize&&this.resize()}};let r=new e.plugin("screenshot",function(t){let i=new e.screenshot(t);t.screenshot=i,t.shoot=function(){i.shoot()},t.add_event_listener(function(t,e){i.jm_event_handle.call(i,t,e)})});e.register_plugin(r)}}(window);
